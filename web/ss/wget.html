<?php

/* Get arguments:
 *   ww_url = full url to post to
 *   ww_cookie = cookie to send
 *   ww_noxhtml = don't translate html for cross-domains
 *   ww_noscript = remove javascripts
 *   ww_post = ignore _POST, and use this
 *
 * NOTE: Later will include a flag whether or not to send back headers.
 */

set_include_path("." . PATH_SEPARATOR . ($UserDir = dirname($_SERVER['DOCUMENT_ROOT'])) . "/pear/php" . PATH_SEPARATOR . get_include_path());
$pear_user_config = $UserDir . "/.pearrc";

require_once("Net/URL2.php");

// Modified from http://davidwalsh.name/execute-http-post-php-curl

// url-ify the data for the POST
if ($_GET['ww_post']) {
  $fields_string = $_GET['ww_post'];
} else {
  $fields_string = "";
  foreach ($_POST as $key=>$value)
    $fields_string .= $key . '=' . urlencode($value) . '&';
  rtrim($fields_string, '&');
}

$url = $_GET['ww_url'];
if (!$url)
  $url = $_POST['ww_url'];

// url-ify the data for GET
$urlargs = "";
foreach ($_GET as $key=>$value) {
  if (strpos($key, 'ww_') === 0)
    continue;
  $urlargs .= $key . '=' . urlencode($value) . '&';
}
rtrim($urlargs, '&');
if (strlen($urlargs) > 0)
  $url .= (strpos($url, '?') ? '&' : '?') . $urlargs;

// create a new cURL resource
$ch = curl_init();

// set URL and other appropriate options
curl_setopt($ch, CURLOPT_URL, $url);
curl_setopt($ch, CURLOPT_HEADER, 1);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);
curl_setopt($ch, CURLOPT_POST, count($_POST));
curl_setopt($ch, CURLOPT_POSTFIELDS, $fields_string);
if ($_GET['ww_cookie'])
  curl_setopt($ch, CURLOPT_HTTPHEADER, array('Cookie: ' . $_GET['ww_cookie'])); 

// grab URL and pass it to the browser
$result = curl_exec($ch);

// Extract cookies
preg_match('/^Set-Cookie: (.*?);/m', curl_exec($ch), $m);
$cookie = $m[1];

// close cURL resource, and free up system resources
curl_close($ch);

if ($_GET['ww_noxhtml']) {
  echo $result;
  exit(1);
}

require_once("simple_html_dom.php");

$html = str_get_html($result);

// Replace relatives with absolute
$uri = new Net_URL2($url); // URI of the resource
$baseURI = $uri;
foreach ($html->find('base[href]') as $elem)
  $baseURI = $uri->resolve($elem->href);

foreach ($html->find('*[src]') as $elem)
  $elem->src = $baseURI->resolve($elem->src)->__toString();

foreach ($html->find('*[href]') as $elem) {
  if (strtoupper($elem->tag) === 'BASE') continue;
  $elem->href = $baseURI->resolve($elem->href)->__toString();
}

foreach ($html->find('form[action]') as $elem) {
  $oldact = $elem->action;
  $elem->action = $_SERVER['PHP_SELF'];
  $elem->innertext .= '<input type="hidden" name="ww_url" value="' . htmlspecialchars($baseURI->resolve($oldact)->__toString()) . '" />';
}

if ($_GET['ww_noscript']) {
  foreach ($html->find('script') as $elem)
    $elem->outertext = "";
}

$body = $html->find('body', 0);
if ($body && $cookie)
  $body->innertext .= '<div id="wget_cookie" style="display: none">' . $cookie . '</div>';

echo $html;

?>
